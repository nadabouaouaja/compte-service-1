---
- name: Build and Deploy Docker Image to Kubernetes
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    image_name: my-country-service         # surcharg√© par -e
    image_tag: latest                      # surcharg√© par -e
    dockerfile_path: '.'                   # surcharg√© par -e
    # kubeconfig fourni par Jenkins (withCredentials:file)
    kubeconfig_path: "{{ lookup('env','KUBECONFIG') }}"
    k8s_namespace: default                  # change en 'default' si besoin

  module_defaults:
    community.docker.docker_image:
      source: build
    kubernetes.core.k8s:
      kubeconfig: "{{ kubeconfig_path }}"
      context: docker-desktop

  tasks:
    - name: üîê Docker login (env DOCKERHUB_USER/DOCKERHUB_PWD)
      community.general.docker_login:
        username: "{{ lookup('env','DOCKERHUB_USER') }}"
        password: "{{ lookup('env','DOCKERHUB_PWD') }}"
        reauthorize: true

    - name: üèóÔ∏è Build Docker image
      community.docker.docker_image:
        build:
          path: "{{ dockerfile_path }}"
        name: "{{ lookup('env','DOCKERHUB_USER') }}/{{ image_name }}"
        tag: "{{ image_tag }}"
        state: present

    - name: üöÄ Push Docker image
      community.docker.docker_image:
        name: "{{ lookup('env','DOCKERHUB_USER') }}/{{ image_name }}"
        tag: "{{ image_tag }}"
        push: true
        source: local

    - name: üì¶ Apply Deployment
      kubernetes.core.k8s:
        state: present
        namespace: "{{ k8s_namespace }}"
        src: deployment.yaml

    - name: üåê Apply Service
      kubernetes.core.k8s:
        state: present
        namespace: "{{ k8s_namespace }}"
        src: service.yaml




# ---
# - name: Build and Deploy Docker Image to Kubernetes
#   hosts: localhost  # Or your build/deployment server
#   connection: local

#   vars:
#     image_name: my-country-service
#     image_tag: v1
#     dockerfile_path: './'
#     docker_registry_username: "nadabj"
#     docker_registry_password: "197197123"
#     kubeconfig_path: "kubeconfig_docker_desktop"

#   tasks:

#     # 1Ô∏è‚É£ Connexion √† Docker Hub
#     - name: Log in to Docker Hub
#       community.general.docker_login:
#         username: "{{ docker_registry_username }}"
#         password: "{{ docker_registry_password }}"
#         reauthorize: yes

#     # 2Ô∏è‚É£ Construction de l‚Äôimage Docker
#     - name: Build Docker image
#       docker_image:
#         build:
#           path: "{{ dockerfile_path }}"
#         name: "{{ docker_registry_username }}/{{ image_name }}"
#         tag: "{{ image_tag }}"
#         source: build
#         state: present

#     # 3Ô∏è‚É£ Pousser l‚Äôimage vers Docker Hub
#     - name: Push the Docker image to Docker Hub
#       docker_image:
#         name: "{{ docker_registry_username }}/{{ image_name }}"
#         tag: "{{ image_tag }}"
#         push: yes
#         source: local

#     # # 4Ô∏è‚É£ (Optionnel) Ret√©l√©charger l‚Äôimage pour v√©rification
#     # - name: Pull Docker image (optional, for verification or target nodes)
#     #   docker_image:
#     #     name: "{{ docker_registry_username }}/{{ image_name }}"
#     #     tag: "{{ image_tag }}"
#     #     source: pull

#     # 5Ô∏è‚É£ Appliquer le Deployment sur Kubernetes
#     - name: Apply Kubernetes Deployment
#       kubernetes.core.k8s:
#         state: present
#         namespace: jenkins
#         src: deployment.yaml
#         kubeconfig: "{{ kubeconfig_path }}"

#     # 6Ô∏è‚É£ Appliquer le Service sur Kubernetes
#     - name: Apply Kubernetes Service
#       kubernetes.core.k8s:
#         state: present
#         namespace: jenkins
#         src: service.yaml
#         kubeconfig: "{{ kubeconfig_path }}"

# ---
# - name: Build and Deploy Docker Image to Kubernetes
#   hosts: localhost
#   connection: local
#   gather_facts: false

#   vars:
#     image_name: my-country-service
#     image_tag: v1
#     dockerfile_path: './'

#     # R√©cup√®re le kubeconfig inject√© par Jenkins (withCredentials:file)
#     kubeconfig_path: "{{ lookup('env', 'KUBECONFIG') }}"

#   # Bon namespace pour les modules
#   module_defaults:
#     community.docker.docker_image:
#       source: build
#     kubernetes.core.k8s:
#       kubeconfig: "{{ kubeconfig_path }}"
#       context: docker-desktop

#   tasks:
#     - name: üîê Docker login (via variables d'env DOCKERHUB_USER/DOCKERHUB_PWD)
#       community.general.docker_login:
#         username: "{{ lookup('env', 'DOCKERHUB_USER') }}"
#         password: "{{ lookup('env', 'DOCKERHUB_PWD') }}"
#         reauthorize: true

#     - name: üèóÔ∏è Build Docker image
#       community.docker.docker_image:
#         build:
#           path: "{{ dockerfile_path }}"
#         name: "{{ lookup('env', 'DOCKERHUB_USER') }}/{{ image_name }}"
#         tag: "{{ image_tag }}"
#         state: present

#     - name: üöÄ Push Docker image
#       community.docker.docker_image:
#         name: "{{ lookup('env', 'DOCKERHUB_USER') }}/{{ image_name }}"
#         tag: "{{ image_tag }}"
#         push: true
#         source: local

#     - name: üì¶ D√©ploiement K8s - Deployment
#       kubernetes.core.k8s:
#         state: present
#         namespace: jenkins
#         src: deployment.yaml

#     - name: üåê D√©ploiement K8s - Service
#       kubernetes.core.k8s:
#         state: present
#         namespace: jenkins
#         src: service.yaml



